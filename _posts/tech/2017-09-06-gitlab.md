---
layout: post
category : Tech
title : Gitlab å®‰è£…ä¸é…ç½®
tags : [git, gitlab]
---
{% include JB/setup %}


ç›®å½•:


<!-- @import "[TOC]" {cmd="toc" depthFrom=2 depthTo=4 orderedList=false} -->
<!-- code_chunk_output -->

- [1. å®‰è£…](#1-å®‰è£…)
- [2. è‡ªå®šä¹‰é…ç½®](#2-è‡ªå®šä¹‰é…ç½®)
- [3. å¤‡ä»½ä¸è¿˜åŸ](#3-å¤‡ä»½ä¸è¿˜åŸ)
- [4. å¸¸è§é—®é¢˜](#4-å¸¸è§é—®é¢˜)
    - [1.  Error 502 (Whoops, GitLab is taking too much time to respond.)](#1-error-502-whoops-gitlab-is-taking-too-much-time-to-respond)
    - [2. é‡ç½®å¯†ç ](#2-é‡ç½®å¯†ç )
    - [3. è¿è¡Œreconfigureæ—¶æŠ¥é”™](#3-è¿è¡Œreconfigureæ—¶æŠ¥é”™)
    - [4. å‡çº§åå‘ç°éƒ¨åˆ†ä»“åº“æ–‡ä»¶å’Œæäº¤è®°å½•ä¸¢å¤±](#4-å‡çº§åå‘ç°éƒ¨åˆ†ä»“åº“æ–‡ä»¶å’Œæäº¤è®°å½•ä¸¢å¤±)

<!-- /code_chunk_output -->


## 1. å®‰è£…

**1. å®‰è£…åŸºç¡€ä¾èµ–**

```
sudo apt-get install -y curl openssh-server ca-certificates
```

å®‰è£…é‚®ä»¶æœåŠ¡ï¼Œå¦‚æœå·²æœ‰å…¶ä»–é‚®ä»¶æœåŠ¡å™¨ï¼Œå¯å®‰è£…å®Œæˆåé…ç½®ã€‚

```
sudo apt-get install -y postfix
```

**2. å®‰è£…**

```
curl -sS https://packages.gitlab.com/install/repositories/gitlab/gitlab-ce/script.deb.sh | sudo bash
sudo apt-get install gitlab-ce
```

å®˜æ–¹æºå›½å†…ä¸‹è½½é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ï¼Œå¯ä»¥ä½¿ç”¨[æ¸…åå¤§å­¦é•œåƒç«™](https://mirrors.tuna.tsinghua.edu.cn/help/gitlab-ce/)ã€‚

å¦‚æœä¸æƒ³ä½¿ç”¨æºï¼Œå¯æ‰‹åŠ¨å®‰è£…ï¼Œ[ä¸‹è½½åœ°å€](https://packages.gitlab.com/gitlab/gitlab-ce)

```
dpkg -i gitlab-ce-XXX.deb
```

**3. é…ç½®å’Œå¯åŠ¨**

```
sudo gitlab-ctl reconfigure
```

## 2. è‡ªå®šä¹‰é…ç½®

å¦‚æœéœ€è¦æ›´æ”¹ç«¯å£ï¼Œå¦‚ä¸‹æ“ä½œ:

```shell
vim /etc/gitlab/gitlab.rb

# 8181 å³ä¸ºç«¯å£å·
external_url 'http://localhost:8181'
```

## 3. å¤‡ä»½ä¸è¿˜åŸ

```sh
# backup
gitlab-rake gitlab:backup:create
# restore
# gitlab-ctl stop unicorn
# gitlab-ctl stop sidekiq
gitlab-ctl stop

gitlab-rake gitlab:backup:restore BACKUP=${backupid}

# v13 ä½¿ç”¨ gitlab-backup
gitlab-backup restore BACKUP=${backupid}
```
âš ï¸ ***æ³¨æ„***: è¿˜åŸä¸åˆ›å»ºå¤‡ä»½çš„gitlabç‰ˆæœ¬éœ€ä¸€è‡´.

## 4. å¸¸è§é—®é¢˜

#### 1.  Error 502 (Whoops, GitLab is taking too much time to respond.)

1. å‰©ä½™ç©ºé—²å†…å­˜å¤ªå°‘ï¼Œ å†…éƒ¨è¿è¡Œå‡ºé”™
2. ç«¯å£è¢«å ç”¨ï¼Œ gitlabçš„`gitlab-workhorse`, `unicorn`å ç”¨8080

#### 2. é‡ç½®å¯†ç 

```sh
sudo gitlab-rails console -e production

user = User.where(id: 1).first
user.password=${password}
user.password_confirmation=${password}
user.save!
quit
```

#### 3. è¿è¡Œreconfigureæ—¶æŠ¥é”™

```
["usermod", "-s", "/bin/sh", "-d", "/var/opt/gitlab", "git"]
```

å¯èƒ½æ˜¯`git`ç”¨æˆ·çš„ç”¨æˆ·ä¸»ç›®å½•é”™è¯¯ï¼Œä¿®æ”¹ä¸º`/var/opt/gitlab`å³å¯ã€‚

å¼•ç”¨èµ„æ–™:[æŸ¥çœ‹](https://superuser.com/questions/782895/installing-gitlab-on-centos7-failing-due-to-create-on-resource-user)

#### 4. å‡çº§åå‘ç°éƒ¨åˆ†ä»“åº“æ–‡ä»¶å’Œæäº¤è®°å½•ä¸¢å¤±

##### ç¬¬ä¸€æ¬¡æ¢å¤

å°è¯•æ¢å¤å¤‡ä»½æ–‡ä»¶ï¼Œè¿˜å¥½æœ‰å…«æœˆä»½çš„å¤‡ä»½æ–‡ä»¶ï¼Œå¤‡ä»½æ—¶ç‰ˆæœ¬ä¸º"13.0.6"ï¼Œé™ä½ç‰ˆæœ¬ `sudo apt install gitlab-ce=13.0.6-ce.0`ï¼Œæ¢å¤å¤‡ä»½æ–‡ä»¶ `gitlab-backup restore BACKUP=1597135522_2020_08_11_13.0.6`ã€‚ç»è¿‡ä¸€ç•ªæŠ˜è…¾æ–‡ä»¶æ¢å¤äº†ä½†æ˜¯æ— æ³•æäº¤ï¼Œä»“åº“éƒ½å˜ä¸ºåªè¯»äº†ï¼ŒğŸ˜‚ï¼Œæœ¬æ¬¡æ¢å¤ä»¥å¤±è´¥å‘Šç»ˆã€‚

##### ç¬¬äºŒæ¬¡æ¢å¤

ç»è¿‡ä¸Šæ¬¡å°è¯•ï¼ŒçŒœæƒ³åº”è¯¥æ˜¯å…ƒæ•°æ®æˆ–è€…æƒé™å‡ºç°é—®é¢˜ï¼Œä½†æ˜¯ä¸çŸ¥é“å¦‚ä½•ä¿®å¤ï¼Œæ°å¥½å‘ç°æ”¯æŒå¯¼å…¥å¯¼å‡ºé¡¹ç›®ï¼Œå¯é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚å¦å¤–ä¹Ÿå¯é€šè¿‡ `gitlab-rake` å¯¼å…¥è£¸ä»“åº“ï¼Œä½†æ˜¯å…ƒæ•°æ®ä¸ä¼šå¯¼å…¥ï¼Œå› æ­¤ä¸é‡‡ç”¨è¿™ç§æ–¹å¼ã€‚

1. åˆå§‹åŒ– gitlab

```shell
sudo gitlab-ctl stop
sudo apt purge gitlab-ce
sudo rm -rf /etc/gitlab
sudo rm -rf /opt/gitlab
sudo rm -rf /var/opt/gitlab
# é…ç½® EXTERNAL_URL ç¯å¢ƒå˜é‡å¹¶å®‰è£…
# sudo EXTERNAL_URL="http://gitlab.cofcool.net" apt install gitlab-ce
sudo apt install gitlab-ce
# ä¿®æ”¹é…ç½®æ–‡ä»¶
sudo vim /etc/gitlab/gitlab.rb
sudo gitlab-ctl reconfigure
```

2. é…ç½® docker-compose

```sh
sudo apt install docker.io docker-compose

# docker-compose.yml
tee docker-compose.yml <<EOF
web:
  image: 'gitlab/gitlab-ce:13.0.6-ce.0'
  restart: always
  hostname: 'gitlab.cofcool.net'
  environment:
    GITLAB_OMNIBUS_CONFIG: |
      external_url 'http://gitlab.cofcool.net'
  ports:
    - '8181:80'
  volumes:
    - '/home/cofcool/gitlab/config:/etc/gitlab'
    - '/home/cofcool/gitlab/logs:/var/log/gitlab'
    - '/home/cofcool/gitlab/data:/var/opt/gitlab'
EOF

# å¯åŠ¨é¡¹ç›®
docker-compose up -d

# å¯¼å…¥å¤‡ä»½æ•°æ®
docker exec -it web_1 gitlab-backup restore BACKUP=1597135522_2020_08_11_13.0.6
```

3. å¯¼å…¥å¯¼å‡º